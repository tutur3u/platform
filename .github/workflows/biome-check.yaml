name: Biome Check

on:
  push:
    branches-ignore:
      - 'dependabot/**'
      - 'staging'
      - 'production'
  workflow_dispatch:

jobs:
  format:
    name: Biome Check
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          fetch-depth: 2
          # Required for creating commits and PRs
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest

      - name: Check Biome formatting and linting
        id: biome-check
        run: |
          # Capture biome output and exit code
          set +e
          biome_output=$(biome ci . 2>&1)
          biome_exit_code=$?
          set -e
          
          echo "biome_exit_code=$biome_exit_code" >> $GITHUB_OUTPUT
          
          # Save output to file for debugging
          echo "$biome_output" > biome_output.txt
          
          # Parse biome output for statistics - looking for the final summary lines
          # Strip ANSI color codes first, then parse
          clean_output=$(echo "$biome_output" | sed 's/\x1b\[[0-9;]*m//g')

          files_checked=$(echo "$clean_output" | grep "Checked [0-9]* files" | sed 's/Checked \([0-9]*\) files.*/\1/' || echo "0")
          errors=$(echo "$clean_output" | grep "Found [0-9]* errors" | sed 's/Found \([0-9]*\) errors.*/\1/' || echo "0")
          warnings=$(echo "$clean_output" | grep "Found [0-9]* warnings" | sed 's/Found \([0-9]*\) warnings.*/\1/' || echo "0")
          total_issues=$((errors + warnings))
          
          echo "files_checked=$files_checked" >> $GITHUB_OUTPUT
          echo "errors=$errors" >> $GITHUB_OUTPUT
          echo "warnings=$warnings" >> $GITHUB_OUTPUT
          echo "total_issues=$total_issues" >> $GITHUB_OUTPUT
          
          # Check if there are any issues
          if [ "$biome_exit_code" -ne 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with progress
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR number from context or search for PR associated with this branch
            let prNumber = null;
            
            if (context.issue && context.issue.number) {
              prNumber = context.issue.number;
            } else {
              // For push events, find PR associated with this branch
              try {
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
                  state: 'open'
                });
                
                if (prs.length > 0) {
                  prNumber = prs[0].number;
                }
              } catch (error) {
                console.log('No PR found for this branch or error occurred:', error.message);
                return; // Exit if no PR is found
              }
            }
            
            if (!prNumber) {
              console.log('No PR found to comment on');
              return;
            }
            
            const filesChecked = '${{ steps.biome-check.outputs.files_checked }}';
            const originalErrors = '${{ steps.biome-check.outputs.errors }}';
            const originalWarnings = '${{ steps.biome-check.outputs.warnings }}';
            const totalIssues = '${{ steps.biome-check.outputs.total_issues }}';
            const hasIssues = '${{ steps.biome-check.outputs.has_issues }}';
            
            let body;
            
            if (hasIssues === 'false') {
              body = `
              ## âœ… Biome Check Passed

              <div align="center">

              ğŸ‰ **Congratulations! Your code is 100% clean!** ğŸ‰

              </div>

              ### ğŸ“Š Summary

              | Metric | Value |
              |--------|-------|
              | ğŸ“ **Files Checked** | ${filesChecked} |
              | âœ¨ **Issues Found** | 0 |
              | ğŸ† **Code Quality** | 100% |
              | ğŸ¯ **Status** | Perfect! |

              <div align="center">

              **ğŸŒŸ Your code meets all quality standards! ğŸŒŸ**

              </div>
              `;
            } else {
              const issueIcon = totalIssues > 50 ? 'ğŸš¨' : totalIssues > 20 ? 'âš ï¸' : totalIssues > 10 ? 'ğŸ”' : 'ğŸ”§';
              const errorStatus = originalErrors > 0 ? 'ğŸ”´ Needs fixing' : 'âœ… None';
              const warningStatus = originalWarnings > 0 ? 'ğŸŸ¡ Consider fixing' : 'âœ… None';
              const totalStatus = totalIssues > 0 ? 'ğŸ“Š See details above' : 'ğŸ¯ Perfect!';
              
              const nextSteps = totalIssues > 0 ? 
                '### ğŸ› ï¸ Next Steps\n\nRun the following command to fix issues:\n```bash\nbun format-and-lint:fix\n```\nThen commit and push the changes.' : 
                '### ğŸ‰ All Issues Resolved!\n\nYour code is now **100% clean**! Great job! ğŸ†';
              
              const timestamp = new Date().toLocaleString();
              
              body = `
              ## ${issueIcon} Biome Check Report

              <div align="center">

              ### Issues Found: **${totalIssues}**

              </div>

              ### ğŸ“Š Analysis Summary

              | Metric | Value | Status |
              |--------|-------|--------|
              | ğŸ“ **Files Checked** | ${filesChecked} | âœ… Complete |
              | âŒ **Errors** | ${originalErrors} | ${errorStatus} |
              | âš ï¸ **Warnings** | ${originalWarnings} | ${warningStatus} |
              | ğŸ“ **Total Issues** | ${totalIssues} | ${totalStatus} |

              ${nextSteps}

              <div align="center">
              <sub>ğŸ¤– Auto-generated by <strong>Biome Check</strong> workflow â€¢ Last updated: ${timestamp}</sub>
              </div>
              `;
            }

            // Find existing Biome Check comment and update it, or create new one
            try {
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              // Look for existing Biome Check comment with more specific markers
              const existingComment = comments.find(comment => 
                comment.user.login === 'github-actions[bot]' && 
                comment.body.includes('<!-- biome-check-comment -->')
              );

              // Add a unique marker to identify our comments
              const bodyWithMarker = '<!-- biome-check-comment -->\n' + body;

              if (existingComment) {
                console.log(`Updating existing comment ${existingComment.id} on PR ${prNumber}`);
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: bodyWithMarker
                });
              } else {
                console.log(`Creating new comment on PR ${prNumber}`);
                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: bodyWithMarker
                });
              }
            } catch (error) {
              console.log('Error managing PR comment:', error.message);
            }