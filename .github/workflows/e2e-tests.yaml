name: E2E Tests

on:
  push:

jobs:
  check-ci:
    uses: ./.github/workflows/ci-check.yml
    with:
      workflow_name: e2e-tests.yaml

  e2e:
    name: Playwright E2E
    needs: [check-ci]
    if: needs.check-ci.outputs.should_run == 'true'
    timeout-minutes: 20
    runs-on: ubuntu-latest

    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

      # Local Supabase (well-known demo keys — only valid against ephemeral local instance)
      NEXT_PUBLIC_SUPABASE_URL: http://127.0.0.1:8001
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      SUPABASE_SECRET_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
      BASE_URL: http://localhost:7803
      NODE_ENV: development

    steps:
      - name: Check out code
        uses: actions/checkout@v6

      # --- Supabase local stack ---
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Get Supabase CLI version
        id: supabase-version
        run: echo "version=$(supabase --version)" >> "$GITHUB_OUTPUT"

      - name: Restore cached Docker images
        id: cache-supabase
        uses: actions/cache/restore@v5
        with:
          path: /tmp/supabase-docker
          key: supabase-docker-${{ runner.os }}-${{ steps.supabase-version.outputs.version }}

      - name: Load cached Docker images
        if: steps.cache-supabase.outputs.cache-hit == 'true'
        run: docker load -i /tmp/supabase-docker/images.tar || true

      - name: Start local Supabase
        id: start-supabase
        working-directory: apps/database
        run: |
          if supabase start; then
            echo "pruned=false" >> "$GITHUB_OUTPUT"
          else
            echo "Retrying after Docker prune..."
            docker system prune -af
            supabase start
            echo "pruned=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Delete corrupted cache
        if: steps.start-supabase.outputs.pruned == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh cache delete "supabase-docker-${{ runner.os }}-${{ steps.supabase-version.outputs.version }}" --repo "${{ github.repository }}" || true

      - name: Save Docker images for cache
        if: steps.cache-supabase.outputs.cache-hit != 'true' || steps.start-supabase.outputs.pruned == 'true'
        run: |
          mkdir -p /tmp/supabase-docker
          docker images --format '{{.Repository}}:{{.Tag}}' | grep 'supabase/' | grep -v '<none>' | xargs -r docker save -o /tmp/supabase-docker/images.tar

      - name: Cache Docker images
        if: steps.cache-supabase.outputs.cache-hit != 'true' || steps.start-supabase.outputs.pruned == 'true'
        uses: actions/cache/save@v5
        with:
          path: /tmp/supabase-docker
          key: supabase-docker-${{ runner.os }}-${{ steps.supabase-version.outputs.version }}

      - name: Reset database (apply migrations + seed)
        working-directory: apps/database
        run: supabase db reset

      # --- Node / Bun ---
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Cache turbo build
        uses: actions/cache@v5
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-e2e-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-e2e-
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: bun install

      - name: Build workspace dependencies
        run: bunx turbo run build --filter=@tuturuuu/types --filter=@tuturuuu/supabase

      - name: Install Playwright browsers (web)
        working-directory: apps/web
        run: bunx playwright install chromium

      - name: Install Playwright browsers (tasks)
        working-directory: apps/tasks
        run: bunx playwright install chromium

      # --- Start dev servers ---
      - name: Start web app
        working-directory: apps/web
        run: |
          NODE_OPTIONS='--experimental-require-module' npx next dev -p 7803 --turbopack &
          echo "Waiting for web dev server..."

      - name: Start tasks app
        working-directory: apps/tasks
        run: |
          NODE_OPTIONS='--experimental-require-module' npx next dev -p 7809 --turbopack &
          echo "Waiting for tasks dev server..."

      - name: Wait for web dev server to be ready
        run: |
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:7803/login | grep -q "200\|302\|307"; then
              echo "Web dev server is ready!"
              exit 0
            fi
            echo "Attempt $i/60 — waiting 5s..."
            sleep 5
          done
          echo "Web dev server failed to start within 5 minutes"
          exit 1

      - name: Wait for tasks dev server to be ready
        run: |
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:7809 | grep -q "200\|302\|307"; then
              echo "Tasks dev server is ready!"
              exit 0
            fi
            echo "Attempt $i/60 — waiting 5s..."
            sleep 5
          done
          echo "Tasks dev server failed to start within 5 minutes"
          exit 1

      # --- Run E2E tests ---
      - name: Run Playwright tests (web)
        working-directory: apps/web
        run: bunx playwright test

      - name: Run Playwright tests (tasks)
        working-directory: apps/tasks
        env:
          BASE_URL: http://localhost:7809
          WEB_BASE_URL: http://localhost:7803
        run: bunx playwright test

      # --- Upload artifacts on failure ---
      - name: Upload web Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-web
          path: apps/web/blob-report/
          retention-days: 14

      - name: Upload web test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results-web
          path: apps/web/test-results/
          retention-days: 14

      - name: Upload tasks Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-tasks
          path: apps/tasks/blob-report/
          retention-days: 14

      - name: Upload tasks test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results-tasks
          path: apps/tasks/test-results/
          retention-days: 14

      # --- Cleanup ---
      - name: Stop Supabase
        if: always()
        working-directory: apps/database
        run: supabase stop
