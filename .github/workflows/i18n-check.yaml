name: i18n Check

on:
  push:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  i18n-sort-check:
    name: Translation Sort Check
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is_sorted: ${{ steps.sort-check.outputs.is_sorted }}
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Check if translations are sorted
        id: sort-check
        run: |
          set +e
          sort_output=$(node scripts/i18n-sort.js --check 2>&1)
          sort_exit_code=$?
          set -e

          # Print the output for visibility
          echo "$sort_output"

          if [ "$sort_exit_code" -ne 0 ]; then
            echo "is_sorted=false" >> $GITHUB_OUTPUT
          else
            echo "is_sorted=true" >> $GITHUB_OUTPUT
          fi

          exit $sort_exit_code

  i18n-translation-check:
    name: Translation Keys Check
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      issue_count: ${{ steps.i18n-check.outputs.issue_count }}
      has_issues: ${{ steps.i18n-check.outputs.has_issues }}
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run i18n-check
        id: i18n-check
        run: |
          set +e
          i18n_output=$(bun i18n:check 2>&1)
          i18n_exit_code=$?
          set -e

          echo "exit_code=$i18n_exit_code" >> $GITHUB_OUTPUT

          # Save output to file for debugging
          echo "$i18n_output" > i18n_output.txt

          # Count issues from output
          if [ "$i18n_exit_code" -ne 0 ]; then
            # Extract issue count from the table output
            issue_count=$(echo "$i18n_output" | grep -c "‚îÇ.*‚îÇ.*‚îÇ" || echo "0")
            # Subtract header rows
            issue_count=$((issue_count > 2 ? issue_count - 2 : 0))
            echo "issue_count=$issue_count" >> $GITHUB_OUTPUT
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "issue_count=0" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

          # Print the output for visibility
          echo "$i18n_output"

          # Fail the step if there are issues
          exit $i18n_exit_code

  comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [i18n-sort-check, i18n-translation-check]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Comment on PR with i18n status
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;

            if (!prNumber) {
              console.log('No PR found to comment on');
              return;
            }

            const isSorted = '${{ needs.i18n-sort-check.outputs.is_sorted }}';
            const hasTranslationIssues = '${{ needs.i18n-translation-check.outputs.has_issues }}';
            const issueCount = '${{ needs.i18n-translation-check.outputs.issue_count }}';

            const timestamp = new Date().toLocaleString();

            const sortStatus = isSorted === 'true' ? '‚úÖ Sorted' : '‚ùå Not sorted';
            const translationStatus = hasTranslationIssues === 'true' ? '‚ùå Issues found' : '‚úÖ All in sync';
            const overallSuccess = isSorted === 'true' && hasTranslationIssues !== 'true';

            let nextSteps = '';
            if (!overallSuccess) {
              nextSteps = '### üìã Next Steps\n\n';
              if (isSorted !== 'true') {
                nextSteps += '**Sorting Issues:**\n```bash\nbun i18n:sort\n```\n\n';
              }
              if (hasTranslationIssues === 'true') {
                nextSteps += '**Translation Issues:**\n```bash\nbun i18n:check\n```\n';
              }
            }

            const body = `
            ## üåê i18n Check Report

            <div align="center">

            ${overallSuccess ? '### ‚úÖ All i18n checks passed!' : '### ‚ùå i18n issues found'}

            </div>

            | Check | Status |
            |-------|--------|
            | üî§ **Translation Sorting** | ${sortStatus} |
            | üîë **Translation Keys** | ${translationStatus} ${hasTranslationIssues === 'true' ? `(${issueCount} issues)` : ''} |

            ${nextSteps}

            <div align="center">
            <sub>ü§ñ Auto-generated by <strong>i18n Check</strong> workflow ‚Ä¢ Last updated: ${timestamp}</sub>
            </div>
            `;

            // Find existing i18n Check comment and update it, or create new one
            try {
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const existingComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('<!-- i18n-check-comment -->')
              );

              const bodyWithMarker = '<!-- i18n-check-comment -->\n' + body;

              if (existingComment) {
                console.log(`Updating existing comment ${existingComment.id} on PR ${prNumber}`);
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: bodyWithMarker
                });
              } else {
                console.log(`Creating new comment on PR ${prNumber}`);
                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: bodyWithMarker
                });
              }
            } catch (error) {
              console.log('Error managing PR comment:', error.message);
            }
