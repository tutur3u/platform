name: i18n Check

on:
  push:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-ci:
    uses: ./.github/workflows/ci-check.yml
    with:
      workflow_name: i18n-check.yaml

  i18n-sort-check:
    name: Translation Sort Check
    needs: [check-ci]
    if: needs.check-ci.outputs.should_run == 'true'
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is_sorted: ${{ steps.sort-check.outputs.is_sorted }}
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check if translations are sorted
        id: sort-check
        run: |
          set +e
          sort_output=$(node scripts/i18n-sort.js --check 2>&1)
          sort_exit_code=$?
          set -e

          # Print the output for visibility
          echo "$sort_output"

          if [ "$sort_exit_code" -ne 0 ]; then
            echo "is_sorted=false" >> $GITHUB_OUTPUT
          else
            echo "is_sorted=true" >> $GITHUB_OUTPUT
          fi

          exit $sort_exit_code

  i18n-translation-check:
    name: Translation Keys Check
    needs: [check-ci]
    if: needs.check-ci.outputs.should_run == 'true'
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      issue_count: ${{ steps.i18n-check.outputs.issue_count }}
      has_issues: ${{ steps.i18n-check.outputs.has_issues }}
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run i18n-check
        id: i18n-check
        run: |
          set +e
          i18n_output=$(bun i18n:check 2>&1)
          i18n_exit_code=$?
          set -e

          echo "exit_code=$i18n_exit_code" >> $GITHUB_OUTPUT

          # Save output to file for debugging
          echo "$i18n_output" > i18n_output.txt

          # Count issues from output
          if [ "$i18n_exit_code" -ne 0 ]; then
            # Extract issue count from the table output
            issue_count=$(echo "$i18n_output" | grep -c "â”‚.*â”‚.*â”‚" || echo "0")
            # Subtract header rows
            issue_count=$((issue_count > 2 ? issue_count - 2 : 0))
            echo "issue_count=$issue_count" >> $GITHUB_OUTPUT
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "issue_count=0" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

          # Print the output for visibility
          echo "$i18n_output"

          # Fail the step if there are issues
          exit $i18n_exit_code

  i18n-key-parity-check:
    name: Key Parity Check (en â†” vi)
    needs: [check-ci]
    if: needs.check-ci.outputs.should_run == 'true'
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_issues: ${{ steps.parity-check.outputs.has_issues }}
      missing_in_vi: ${{ steps.parity-check.outputs.missing_in_vi }}
      missing_in_en: ${{ steps.parity-check.outputs.missing_in_en }}
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Run key parity check
        id: parity-check
        run: |
          set +e
          parity_output=$(node scripts/i18n-key-parity.js 2>&1)
          parity_exit_code=$?
          set -e

          echo "$parity_output"

          if [ "$parity_exit_code" -ne 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            # Extract counts from output
            missing_vi=$(echo "$parity_output" | grep -o '[0-9]* key(s) missing in vi.json' | grep -o '[0-9]*' | head -1 || echo "0")
            missing_en=$(echo "$parity_output" | grep -o '[0-9]* key(s) missing in en.json' | grep -o '[0-9]*' | head -1 || echo "0")
            echo "missing_in_vi=${missing_vi:-0}" >> $GITHUB_OUTPUT
            echo "missing_in_en=${missing_en:-0}" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "missing_in_vi=0" >> $GITHUB_OUTPUT
            echo "missing_in_en=0" >> $GITHUB_OUTPUT
          fi

          exit $parity_exit_code

  i18n-namespace-check:
    name: Namespace Check (shared â†’ apps)
    needs: [check-ci]
    if: needs.check-ci.outputs.should_run == 'true'
    timeout-minutes: 10
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_issues: ${{ steps.namespace-check.outputs.has_issues }}
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Run namespace check
        id: namespace-check
        run: |
          set +e
          namespace_output=$(node scripts/i18n-namespace-check.js 2>&1)
          namespace_exit_code=$?
          set -e

          echo "$namespace_output"

          if [ "$namespace_exit_code" -ne 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

          exit $namespace_exit_code

  comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [i18n-sort-check, i18n-translation-check, i18n-key-parity-check, i18n-namespace-check]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Comment on PR with i18n status
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;

            if (!prNumber) {
              console.log('No PR found to comment on');
              return;
            }

            const isSorted = '${{ needs.i18n-sort-check.outputs.is_sorted }}';
            const hasTranslationIssues = '${{ needs.i18n-translation-check.outputs.has_issues }}';
            const issueCount = '${{ needs.i18n-translation-check.outputs.issue_count }}';
            const hasParityIssues = '${{ needs.i18n-key-parity-check.outputs.has_issues }}';
            const missingInVi = '${{ needs.i18n-key-parity-check.outputs.missing_in_vi }}';
            const missingInEn = '${{ needs.i18n-key-parity-check.outputs.missing_in_en }}';
            const hasNamespaceIssues = '${{ needs.i18n-namespace-check.outputs.has_issues }}';

            const timestamp = new Date().toLocaleString();

            const sortStatus = isSorted === 'true' ? 'âœ… Sorted' : 'âŒ Not sorted';
            const translationStatus = hasTranslationIssues === 'true' ? 'âŒ Issues found' : 'âœ… All in sync';
            const parityStatus = hasParityIssues === 'true' ? 'âŒ Keys mismatch' : 'âœ… Keys in sync';
            const namespaceStatus = hasNamespaceIssues === 'true' ? 'âŒ Missing namespaces' : 'âœ… All present';
            const overallSuccess = isSorted === 'true' && hasTranslationIssues !== 'true' && hasParityIssues !== 'true' && hasNamespaceIssues !== 'true';

            let parityDetails = '';
            if (hasParityIssues === 'true') {
              const details = [];
              if (parseInt(missingInVi) > 0) details.push(`${missingInVi} missing in vi.json`);
              if (parseInt(missingInEn) > 0) details.push(`${missingInEn} missing in en.json`);
              parityDetails = details.length > 0 ? ` (${details.join(', ')})` : '';
            }

            let nextSteps = '';
            if (!overallSuccess) {
              nextSteps = '### ğŸ“‹ Next Steps\n\n';
              if (isSorted !== 'true') {
                nextSteps += '**Sorting Issues:**\n```bash\nbun i18n:sort\n```\n\n';
              }
              if (hasTranslationIssues === 'true') {
                nextSteps += '**Translation Issues:**\n```bash\nbun i18n:check\n```\n\n';
              }
              if (hasParityIssues === 'true') {
                nextSteps += '**Key Parity Issues (en â†” vi):**\n```bash\nbun i18n:key-parity\n```\n\n';
                nextSteps += '> ğŸ’¡ Use `bun i18n:sync` to auto-sync missing keys.\n\n';
              }
              if (hasNamespaceIssues === 'true') {
                nextSteps += '**Namespace Issues (shared â†’ apps):**\n```bash\nbun i18n:namespace-check\n```\n\n';
                nextSteps += '> ğŸ’¡ Add missing namespaces to each app\'s `messages/en.json` and `vi.json`, or add exceptions to `i18n-namespace-check.config.json`.\n';
              }
            }

            const body = `
            ## ğŸŒ i18n Check Report

            <div align="center">

            ${overallSuccess ? '### âœ… All i18n checks passed!' : '### âŒ i18n issues found'}

            </div>

            | Check | Status |
            |-------|--------|
            | ğŸ”¤ **Translation Sorting** | ${sortStatus} |
            | ğŸ”‘ **Translation Keys** | ${translationStatus} ${hasTranslationIssues === 'true' ? `(${issueCount} issues)` : ''} |
            | ğŸ”„ **Key Parity (en â†” vi)** | ${parityStatus}${parityDetails} |
            | ğŸ“¦ **Namespace Check (shared â†’ apps)** | ${namespaceStatus} |

            ${nextSteps}

            <div align="center">
            <sub>ğŸ¤– Auto-generated by <strong>i18n Check</strong> workflow â€¢ Last updated: ${timestamp}</sub>
            </div>
            `;

            // Find existing i18n Check comment and update it, or create new one
            try {
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const existingComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('<!-- i18n-check-comment -->')
              );

              const bodyWithMarker = '<!-- i18n-check-comment -->\n' + body;

              if (existingComment) {
                console.log(`Updating existing comment ${existingComment.id} on PR ${prNumber}`);
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: bodyWithMarker
                });
              } else {
                console.log(`Creating new comment on PR ${prNumber}`);
                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: bodyWithMarker
                });
              }
            } catch (error) {
              console.log('Error managing PR comment:', error.message);
            }
